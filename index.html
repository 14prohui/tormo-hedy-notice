<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TORMO HEDY é¡§å®¢é ˆçŸ¥</title>
    <!-- è¼‰å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* è¨­å®šä¸»è¦å­—é«”å’Œæ¥µç°¡èƒŒæ™¯ */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb; /* è¿‘ä¹ç™½è‰² */
        }
        /* ä¿æŒæ´»å‹• Tab æŒ‰éˆ•çš„æ¨£å¼ - é»‘åº•ç™½å­— */
        .tab-active {
            background-color: #1f2937; /* æ¥è¿‘é»‘è‰² */
            color: #ffffff;
            font-weight: 600;
        }
        .llm-button {
            /* Minimalist black button styling for Gemini features */
            background-color: #1f2937;
            color: white;
            padding: 6px 12px;
            border-radius: 9999px; /* full rounded */
            font-size: 0.875rem; /* sm text */
            line-height: 1.25rem;
            transition: background-color 0.2s;
        }
        .llm-button:hover {
            background-color: #4b5563;
        }
        .llm-button:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }
    </style>
</head>
<body>

    <!-- ä¸»å®¹å™¨ï¼šç½®ä¸­ã€éŸ¿æ‡‰å¼æœ€å¤§å¯¬åº¦ -->
    <div class="max-w-3xl mx-auto p-4 sm:p-6 lg:p-8">

        <!-- æ¨™é¡Œå€å¡Š -->
        <header class="text-center mb-8 pt-4">
            <h1 class="text-4xl font-extrabold text-gray-900 tracking-tight">
                TORMO HEDY é¡§å®¢é ˆçŸ¥
            </h1>
            <p class="mt-2 text-lg text-gray-500">
                ç°¡ç´„ï¼è³ªæ„Ÿï¼æ‚¨çš„å°ˆå±¬è®Šé«®æ™‚å…‰ ğŸ–¤
            </p>
        </header>

        <!-- Tab å°èˆªåˆ— -->
        <div class="flex border-b border-gray-200 mb-8 sticky top-0 bg-white z-10">
            <button id="tab-appointment"
                class="tab-btn py-3 px-6 text-sm sm:text-base transition-all duration-200 rounded-t-lg tab-active"
                onclick="showTab('appointment')">
                é ç´„é ˆçŸ¥ ğŸ“…
            </button>
            <button id="tab-perm"
                class="tab-btn py-3 px-6 text-sm sm:text-base text-gray-600 hover:bg-gray-100 transition-all duration-200 rounded-t-lg"
                onclick="showTab('perm')">
                ç‡™é«®å‰é ˆçŸ¥ ğŸ’‡â€â™€ï¸
            </button>
        </div>

        <!-- å…§å®¹å€å¡Š -->
        <main class="bg-white p-6 sm:p-8 rounded-xl shadow-lg border border-gray-100">

            <!-- é ç´„é ˆçŸ¥å…§å®¹ (é è¨­é¡¯ç¤º) -->
            <section id="content-appointment" class="tab-content space-y-6">
                <h2 class="text-2xl font-bold text-gray-800 border-b pb-3 mb-4 flex justify-between items-center">
                    <span id="appointment-title-text">é ç´„é ˆçŸ¥ï¼šæ‚¨çš„å°ˆå±¬æ™‚é–“ ğŸ˜Œ</span>
                    <button id="tts-appointment-btn" class="llm-button flex items-center" onclick="playSection('appointment')">
                        <span class="mr-1">ğŸ”Š æ’­æ”¾é ˆçŸ¥</span>
                    </button>
                </h2>

                <div class="flex items-start">
                    <span class="text-3xl mr-3">ğŸ§˜â€â™€ï¸</span>
                    <p class="text-gray-700 leading-relaxed pt-1">
                        æˆ‘å€‘ç›¡åŠ›å®‰æ’<strong class="font-semibold text-gray-900">ä¸€æ¬¡åªæœå‹™ä¸€ä½å®¢äºº</strong>ï¼Œè®“æ‚¨å¯ä»¥å®‰å¿ƒäº«å—æ•´å€‹éç¨‹ï¼Œæ„Ÿå—å°ˆå±¬ã€ä¸å—æ‰“æ“¾çš„è®Šé«®æ™‚å…‰ã€‚
                    </p>
                </div>

                <div class="flex items-start">
                    <span class="text-3xl mr-3">ğŸ—“ï¸</span>
                    <p class="text-gray-700 leading-relaxed pt-1">
                        éº»ç…©è«‹<strong class="font-semibold text-gray-900">ææ—©é ç´„</strong>ï¼Œä»¥ä¾¿ç‚ºæ‚¨ä¿ç•™æœ€å……è£•ä¸”æ»¿æ„çš„æ™‚æ®µã€‚
                    </p>
                </div>

                <div class="flex items-start">
                    <span class="text-3xl mr-3">ğŸ¤</span>
                    <p class="text-gray-700 leading-relaxed pt-1">
                        æœå‹™ä¸­æœ‰äº›å°æ­¥é©Ÿæœƒç”±æˆ‘å€‘çš„<strong class="font-semibold text-gray-900">å°ˆæ¥­åŠ©ç†</strong>å”åŠ©ã€‚æ‰€æœ‰åŠ©ç†çš†ç¶“éåš´æ ¼è¨“ç·´ï¼Œè«‹æ”¾å¿ƒï¼å¦‚æœ‰ä»»ä½•ä¸ç¿’æ…£çš„åœ°æ–¹ï¼Œç›¡è«‹åŒ…å®¹èˆ‡å‘ŠçŸ¥ï¼
                    </p>
                </div>
                
                <p class="text-sm text-gray-500 pt-2 italic">
                    (æ­¤ã€Œä¸€å°ä¸€ã€å®‰æ’æ–¼å‡æ—¥æˆ–ç‰¹æ®Šç¯€æ—¥é™¤å¤–ï¼Œå±†æ™‚å¯èƒ½æœƒæœ‰å…¶ä»–å®¢äººåŒæ™‚åœ¨åº—ï¼Œæ„Ÿè¬æ‚¨çš„é«”è«’ã€‚)
                </p>
            </section>

            <!-- ç‡™é«®å‰é ˆçŸ¥å…§å®¹ (é è¨­éš±è—) -->
            <section id="content-perm" class="tab-content space-y-6 hidden">
                <h2 class="text-2xl font-bold text-gray-800 border-b pb-3 mb-4 flex justify-between items-center">
                    <span id="perm-title-text">ç‡™é«®å‰é ˆçŸ¥ï¼šæº–æ™‚æ˜¯ç¾å¾· â±ï¸</span>
                    <button id="tts-perm-btn" class="llm-button flex items-center" onclick="playSection('perm')">
                        <span class="mr-1">ğŸ”Š æ’­æ”¾é ˆçŸ¥</span>
                    </button>
                </h2>
                
                <div class="flex items-start">
                    <span class="text-3xl mr-3">ğŸš¨</span>
                    <div class="pt-1">
                        <p class="text-gray-700 leading-relaxed mb-2">
                            <strong class="font-semibold text-red-600">é ç´„ä¿ç•™æ™‚é–“ç‚º 10 åˆ†é˜ã€‚</strong>è‹¥æ‚¨å¯èƒ½é²åˆ°ï¼Œè«‹å‹™å¿…<strong class="font-semibold text-gray-900">æå‰å‘ŠçŸ¥</strong>ï¼
                        </p>
                        <p class="text-gray-700 leading-relaxed">
                            ç‚ºé¿å…å½±éŸ¿å¾ŒçºŒå®¢äººçš„æœå‹™æ™‚é–“èˆ‡å“è³ªï¼Œå¦‚æ™‚æ®µåš´é‡è¡çªï¼Œæˆ‘å€‘å°‡å”åŠ©æ‚¨<strong class="font-semibold text-gray-900">æ”¹ç´„è‡³å…¶ä»–æ—¥æœŸ</strong>ã€‚è«‹ç†è§£èˆ‡é…åˆï¼
                        </p>
                    </div>
                </div>

                <div class="flex items-start">
                    <span class="text-3xl mr-3">ğŸŒ¡ï¸</span>
                    <p class="text-gray-700 leading-relaxed pt-1">
                        å»ºè­°ç‡™é«®å‰ä¸€å¤©é¿å…ä½¿ç”¨è­·é«®æ²¹æˆ–çŸ½éˆå«é‡é«˜çš„ç”¢å“ï¼Œä»¥ç¢ºä¿è—¥åŠ‘èƒ½å‡å‹»ä½œç”¨æ–¼é«®çµ²ã€‚
                    </p>
                </div>
            </section>
        </main>

        <!-- AI é¡§å®¢æœå‹™å€å¡Š (Gemini LLM Integration) -->
        <section class="max-w-3xl mx-auto p-4 sm:p-6 lg:p-8 mt-8 bg-white rounded-xl shadow-lg border-t-4 border-gray-900">
            <h2 class="text-2xl font-extrabold text-gray-900 mb-4 flex items-center">
                âœ¨ AI é¡§å®¢å•ç­”å°å¹«æ‰‹
            </h2>
            <p class="text-sm text-gray-600 mb-4">
                è«‹è¼¸å…¥é—œæ–¼é ç´„ã€ç‡™é«®æˆ–å…¶ä»–ç¾é«®ç›¸é—œå•é¡Œï¼ŒAI å°‡å³æ™‚ç‚ºæ‚¨æä¾›è§£ç­”èˆ‡å»ºè­°ï¼
            </p>
            
            <div class="flex flex-col sm:flex-row gap-2 mb-4">
                <input type="text" id="qna-input" placeholder="ä¾‹å¦‚ï¼šé²åˆ°å¤šä¹…æœƒè¢«å–æ¶ˆé ç´„ï¼Ÿ"
                       class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900">
                <button id="qna-submit-btn" class="llm-button flex-shrink-0" onclick="askGeminiQnA()">
                    æå•ä¸¦å–å¾—å»ºè­° âœ¨
                </button>
            </div>

            <!-- AI å›è¦†çµæœå€ -->
            <div id="qna-output" class="p-4 bg-gray-50 border border-gray-200 rounded-lg min-h-[50px]">
                <!-- Result will appear here -->
                <p class="text-gray-400 italic">åœ¨æ­¤è™•æŸ¥çœ‹ AI å›è¦†...</p>
            </div>
        </section>

    </div>

    <!-- JavaScript å¯¦ç¾ Tab åˆ‡æ›é‚è¼¯ å’Œ Gemini API æ•´åˆ -->
    <script>
        function showTab(tabName) {
            // éš±è—æ‰€æœ‰å…§å®¹
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });

            // ç§»é™¤æ‰€æœ‰æŒ‰éˆ•çš„ active æ¨£å¼
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('tab-active');
                btn.classList.add('text-gray-600', 'hover:bg-gray-100');
            });

            // é¡¯ç¤ºç•¶å‰é¸ä¸­çš„å…§å®¹
            const selectedContent = document.getElementById(`content-${tabName}`);
            if (selectedContent) {
                selectedContent.classList.remove('hidden');
            }

            // ç‚ºç•¶å‰æŒ‰éˆ•æ·»åŠ  active æ¨£å¼
            const selectedButton = document.getElementById(`tab-${tabName}`);
            if (selectedButton) {
                selectedButton.classList.add('tab-active');
                selectedButton.classList.remove('text-gray-600', 'hover:bg-gray-100');
            }
        }

        // --- Gemini API Configurations ---
        // ğŸš¨ é€™æ˜¯é—œéµä¿®æ­£ï¼šè«‹å°‡ "YOUR_GEMINI_API_KEY_HERE" æ›¿æ›æˆæ‚¨åœ¨ Google AI Studio å–å¾—çš„å¯¦éš› API é‡‘é‘°ã€‚
        // è­¦å‘Šï¼šå°‡é‡‘é‘°ç›´æ¥æ”¾åœ¨å…¬é–‹ç¨‹å¼ç¢¼ä¸­æœƒæœ‰å®‰å…¨é¢¨éšªã€‚
        const API_KEY = "YOUR_GEMINI_API_KEY_HERE"; 
        const QNA_MODEL = "gemini-2.5-flash-preview-09-2025";
        const TTS_MODEL = "gemini-2.5-flash-preview-tts";

        // --- Utility Functions for TTS (PCM to WAV conversion) ---

        /**
         * Converts a base64 string to an ArrayBuffer.
         * @param {string} base64 - Base64 string of the audio data.
         * @returns {ArrayBuffer}
         */
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        /**
         * Converts PCM 16-bit audio data (Int16Array) into a standard WAV format Blob.
         * @param {Int16Array} pcm16 - Raw PCM audio data.
         * @param {number} sampleRate - The sample rate of the audio.
         * @returns {Blob} The audio data as a WAV Blob.
         */
        function pcmToWav(pcm16, sampleRate) {
            const numChannels = 1;
            const bitsPerSample = 16;
            const byteRate = sampleRate * numChannels * (bitsPerSample / 8);
            const blockAlign = numChannels * (bitsPerSample / 8);

            const buffer = new ArrayBuffer(44 + pcm16.byteLength);
            const view = new DataView(buffer);
            let offset = 0;

            /* Helper function to write bytes */
            function writeString(s) {
                for (let i = 0; i < s.length; i++) {
                    view.setUint8(offset++, s.charCodeAt(i));
                }
            }

            /* RIFF header */
            writeString('RIFF'); // Chunk ID
            view.setUint32(offset, 36 + pcm16.byteLength, true); // Chunk Size
            offset += 4;
            writeString('WAVE'); // Format

            /* FMT sub-chunk */
            writeString('fmt '); // Sub-chunk 1 ID
            view.setUint32(offset, 16, true); // Sub-chunk 1 Size (16 for PCM)
            offset += 4;
            view.setUint16(offset, 1, true); // Audio Format (1 for PCM)
            offset += 2;
            view.setUint16(offset, numChannels, true); // Num Channels
            offset += 2;
            view.setUint32(offset, sampleRate, true); // Sample Rate
            offset += 4;
            view.setUint32(offset, byteRate, true); // Byte Rate
            offset += 4;
            view.setUint16(offset, blockAlign, true); // Block Align
            offset += 2;
            view.setUint16(offset, bitsPerSample, true); // Bits Per Sample
            offset += 2;

            /* DATA sub-chunk */
            writeString('data'); // Sub-chunk 2 ID
            view.setUint32(offset, pcm16.byteLength, true); // Sub-chunk 2 Size
            offset += 4;

            /* Write PCM data */
            for (let i = 0; i < pcm16.length; i++) {
                view.setInt16(offset, pcm16[i], true); // Write 16-bit PCM value
                offset += 2;
            }

            return new Blob([view], { type: 'audio/wav' });
        }

        // --- TTS Logic (Text-to-Speech) ---

        // Map section names to the IDs of their main text content and button
        const sectionMap = {
            'appointment': {
                contentId: 'content-appointment',
                buttonId: 'tts-appointment-btn',
                voiceName: 'Kore' // Firm voice (ä¸­æ–‡)
            },
            'perm': {
                contentId: 'content-perm',
                buttonId: 'tts-perm-btn',
                voiceName: 'Puck' // Upbeat voice (ä¸­æ–‡)
            }
        };

        /**
         * Extracts all readable text from a section element for TTS.
         * @param {string} sectionName - 'appointment' or 'perm'.
         * @returns {string} Concatenated text content.
         */
        function extractSectionText(sectionName) {
            const section = document.getElementById(sectionMap[sectionName].contentId);
            if (!section) return "";

            // Concatenate all text from p and strong tags, ignoring the title.
            let text = "";
            section.querySelectorAll('p, strong, li').forEach(el => {
                // Ensure text is clean and readable, replace emojis
                let cleanedText = el.textContent.trim().replace(/[\uD800-\uDBFF\uDC00-\uDFFF]/g, '');
                if (cleanedText) {
                    text += cleanedText + "ã€‚";
                }
            });
            // Add an introductory phrase
            const titleText = document.getElementById(`${sectionName}-title-text`).textContent.trim();
            return `TORMO HEDY ${titleText.replace(/ï¼š.*$/, '')}ã€‚è«‹æ³¨æ„è½ã€‚` + text;
        }


        /**
         * Calls the Gemini TTS API and plays the resulting audio.
         * @param {string} sectionName - 'appointment' or 'perm'.
         */
        async function playSection(sectionName) {
            if (API_KEY === "YOUR_GEMINI_API_KEY_HERE" || API_KEY === "") {
                alert("è«‹å…ˆåœ¨ç¨‹å¼ç¢¼ä¸­å¡«å…¥æ‚¨çš„ Gemini API é‡‘é‘°ï¼Œæ‰èƒ½ä½¿ç”¨èªéŸ³åŠŸèƒ½ï¼");
                return;
            }
            
            const button = document.getElementById(sectionMap[sectionName].buttonId);
            const originalText = button.innerHTML;
            const textToSpeak = extractSectionText(sectionName);
            const voiceName = sectionMap[sectionName].voiceName;
            
            if (!textToSpeak) return;

            // 1. UI State: Disable button and show loading
            button.disabled = true;
            button.innerHTML = '<span class="mr-1">â³ è¼‰å…¥ä¸­...</span>';

            // 2. TTS API Call
            const payload = {
                contents: [{
                    parts: [{ text: textToSpeak }]
                }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: voiceName }
                        }
                    }
                },
                model: TTS_MODEL
            };

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${TTS_MODEL}:generateContent?key=${API_KEY}`;
            
            let audioUrl = null;
            let retries = 0;
            const maxRetries = 5;

            try {
                while (retries < maxRetries) {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        const part = result?.candidates?.[0]?.content?.parts?.[0];
                        const audioData = part?.inlineData?.data;
                        const mimeType = part?.inlineData?.mimeType;

                        if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                            // MimeType for L16 will look like: "audio/L16;rate=24000"
                            const rateMatch = mimeType.match(/rate=(\d+)/);
                            if (!rateMatch || rateMatch.length < 2) throw new Error("Missing sample rate in TTS response.");
                            
                            const sampleRate = parseInt(rateMatch[1], 10);
                            const pcmData = base64ToArrayBuffer(audioData);
                            // API returns signed PCM16 audio data.
                            const pcm16 = new Int16Array(pcmData);
                            const wavBlob = pcmToWav(pcm16, sampleRate);
                            audioUrl = URL.createObjectURL(wavBlob);
                            break; // Success
                        } else {
                            throw new Error("Invalid TTS response structure or missing audio data.");
                        }
                    } else if (response.status === 429) {
                        // Exponential backoff
                        const delay = Math.pow(2, retries) * 1000;
                        retries++;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        throw new Error(`API request failed with status: ${response.status}`);
                    }
                }
                
                if (audioUrl) {
                    // 3. Play Audio
                    const audio = new Audio(audioUrl);
                    audio.play();
                    
                    // Re-enable button after playback finishes
                    audio.onended = () => {
                        button.innerHTML = originalText;
                        button.disabled = false;
                    };
                } else {
                    throw new Error("Failed to get audio data after retries.");
                }

            } catch (error) {
                console.error("TTS Error:", error);
                // ä½¿ç”¨è‡ªå®šç¾©çš„è¨Šæ¯æ¡†å–ä»£ alert
                document.getElementById('qna-output').innerHTML = '<p class="text-red-500">èªéŸ³æ’­æ”¾å¤±æ•—ï¼šè«‹æª¢æŸ¥æ‚¨çš„ API é‡‘é‘°æ˜¯å¦æ­£ç¢ºï¼Œæˆ–ç¶²è·¯é€£ç·šæ˜¯å¦æ­£å¸¸ã€‚ğŸ˜¢</p>';
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.disabled = false;
                }, 3000);
            }
        }

        // --- Q&A Logic (Text Generation) ---

        /**
         * Handles the Q&A button click, calls Gemini, and displays the response.
         */
        async function askGeminiQnA() {
            if (API_KEY === "YOUR_GEMINI_API_KEY_HERE" || API_KEY === "") {
                document.getElementById('qna-output').innerHTML = '<p class="text-red-500">è«‹å…ˆåœ¨ç¨‹å¼ç¢¼ä¸­å¡«å…¥æ‚¨çš„ Gemini API é‡‘é‘°ï¼Œæ‰èƒ½ä½¿ç”¨ AI å•ç­”åŠŸèƒ½ï¼</p>';
                return;
            }
            
            const inputElement = document.getElementById('qna-input');
            const outputElement = document.getElementById('qna-output');
            const submitButton = document.getElementById('qna-submit-btn');
            const userQuery = inputElement.value.trim();

            if (userQuery === "") {
                outputElement.innerHTML = '<p class="text-red-500">è«‹è¼¸å…¥æ‚¨çš„å•é¡Œï¼</p>';
                return;
            }

            // 1. UI State: Disable input/button, show loading
            submitButton.disabled = true;
            submitButton.innerHTML = 'æå•ä¸­...';
            outputElement.innerHTML = '<p class="text-gray-500 animate-pulse">æ­£åœ¨ç‚ºæ‚¨å°‹æ‰¾è§£ç­”ï¼Œè«‹ç¨å€™...</p>';
            
            // Add context to the prompt based on the notices to make the answer grounded.
            const appointmentText = document.getElementById('content-appointment').textContent.trim();
            const permText = document.getElementById('content-perm').textContent.trim();
            
            const systemPrompt = `ä½ æ˜¯ä¸€å€‹å°ˆæ¥­ä¸”è¦ªåˆ‡çš„ TORMO HEDY ç¾é«®æ²™é¾ AI é¡§å®¢æœå‹™å°ˆå“¡ã€‚è«‹æ ¹æ“šä»¥ä¸‹æä¾›çš„ã€Œé ç´„é ˆçŸ¥ã€å’Œã€Œç‡™é«®å‰é ˆçŸ¥ã€å…§å®¹ï¼Œä»¥å°ˆæ¥­ã€ç°¡æ½”ä¸”å‹å–„çš„ä¸­æ–‡å›ç­”é¡§å®¢çš„å•é¡Œã€‚å¦‚æœå•é¡Œèˆ‡é€™äº›é ˆçŸ¥å…§å®¹ç„¡é—œï¼Œè«‹æä¾›ä¸€èˆ¬çš„ç¾é«®å»ºè­°æˆ–ç¦®è²Œåœ°å‘ŠçŸ¥ç„¡æ³•å›ç­”ã€‚ä½ çš„å›ç­”æ‡‰ä¿æŒç°¡ç´„ã€é»‘ç™½çš„é¢¨æ ¼ï¼Œä¸¦ä½¿ç”¨å¯æ„›çš„è¡¨æƒ…ç¬¦è™Ÿ (Emoji) è®“èªæ°£æ›´è¦ªåˆ‡ã€‚`;
            
            const context = `
            --- é¡§å®¢é ˆçŸ¥å…§å®¹ ---
            [é ç´„é ˆçŸ¥]: ${appointmentText}
            [ç‡™é«®å‰é ˆçŸ¥]: ${permText}
            --- é¡§å®¢å•é¡Œ ---
            `;

            const payload = {
                contents: [{ parts: [{ text: context + userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${QNA_MODEL}:generateContent?key=${API_KEY}`;
            
            let resultText = "";
            let retries = 0;
            const maxRetries = 5;
            
            try {
                while (retries < maxRetries) {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        resultText = result.candidates?.[0]?.content?.parts?.[0]?.text || "æŠ±æ­‰ï¼Œç„¡æ³•å–å¾— AI å›è¦†ã€‚";
                        break; // Success
                    } else if (response.status === 429) {
                        // Exponential backoff
                        const delay = Math.pow(2, retries) * 1000;
                        retries++;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        throw new Error(`API request failed with status: ${response.status}`);
                    }
                }
                
                // 2. Display Result
                if (resultText) {
                    outputElement.innerHTML = `<p class="text-gray-800 whitespace-pre-wrap">${resultText}</p>`;
                    inputElement.value = ''; // Clear input
                } else {
                    outputElement.innerHTML = '<p class="text-red-500">å¾ˆæŠ±æ­‰ï¼Œç„¡æ³•å–å¾— AI çš„å›æ‡‰ã€‚è«‹ç¨å¾Œå†è©¦ä¸€æ¬¡ã€‚ğŸ˜¢</p>';
                }

            } catch (error) {
                console.error("QNA Error:", error);
                outputElement.innerHTML = '<p class="text-red-500">é€£ç·šéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥æ‚¨çš„ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦ã€‚ğŸ› ï¸</p>';
            } finally {
                // 3. UI State: Re-enable
                submitButton.disabled = false;
                submitButton.innerHTML = 'æå•ä¸¦å–å¾—å»ºè­° âœ¨';
            }
        }

        // é é¢è¼‰å…¥æ™‚ï¼Œç¢ºä¿ç¬¬ä¸€å€‹ Tab è¢«é¸ä¸­ä¸¦é¡¯ç¤º
        window.onload = () => {
            showTab('appointment');
        };
    </script>

</body>
</html>